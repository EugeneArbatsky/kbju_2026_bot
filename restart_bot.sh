#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ Telegram –±–æ—Ç–∞
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./restart_bot.sh

BOT_FILE="bot.py"
LOG_FILE="bot.log"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

cd "$SCRIPT_DIR"

echo "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –≤—Å–µ –∑–∞–ø—É—â–µ–Ω–Ω—ã–µ —ç–∫–∑–µ–º–ø–ª—è—Ä—ã –±–æ—Ç–∞..."

# –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –±–æ—Ç–∞ (–Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–ø–æ—Å–æ–±–æ–≤ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏)
PIDS1=$(ps aux | grep -E "[p]ython3.*bot\.py" | awk '{print $2}')
PIDS2=$(ps aux | grep -E "[p]ython.*bot\.py" | awk '{print $2}')
PIDS3=$(pgrep -f "bot.py" 2>/dev/null)
PIDS=$(echo "$PIDS1 $PIDS2 $PIDS3" | tr ' ' '\n' | sort -u | grep -v '^$')

if [ -z "$PIDS" ]; then
    echo "‚úÖ –ë–æ—Ç –Ω–µ –∑–∞–ø—É—â–µ–Ω"
else
    echo "–ù–∞–π–¥–µ–Ω—ã –ø—Ä–æ—Ü–µ—Å—Å—ã: $PIDS"
    # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã
    for PID in $PIDS; do
        if ps -p "$PID" > /dev/null 2>&1; then
            kill -9 "$PID" 2>/dev/null && echo "  ‚úì –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø—Ä–æ—Ü–µ—Å—Å $PID" || echo "  ‚úó –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å $PID"
        fi
    done
    # –ñ–¥–µ–º, –ø–æ–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å—ã –∑–∞–≤–µ—Ä—à–∞—Ç—Å—è
    sleep 3
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ (–±–æ–ª–µ–µ —Ç—â–∞—Ç–µ–ª—å–Ω–æ)
    REMAINING1=$(ps aux | grep -E "[p]ython3.*bot\.py" | awk '{print $2}')
    REMAINING2=$(pgrep -f "bot.py" 2>/dev/null)
    REMAINING=$(echo "$REMAINING1 $REMAINING2" | tr ' ' '\n' | sort -u | grep -v '^$')
    if [ -n "$REMAINING" ]; then
        echo "‚ö†Ô∏è  –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –≤—Å–µ –µ—â–µ –∑–∞–ø—É—â–µ–Ω—ã: $REMAINING"
        echo "   –ü—ã—Ç–∞—é—Å—å –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –µ—â–µ —Ä–∞–∑..."
        for PID in $REMAINING; do
            kill -9 "$PID" 2>/dev/null
        done
        sleep 2
    else
        echo "‚úÖ –í—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
    fi
fi

echo ""
echo "üöÄ –ó–∞–ø—É—Å–∫–∞—é –±–æ—Ç–∞..."

# –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞ –≤ —Ñ–æ–Ω–µ —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º
nohup python3 "$BOT_FILE" > "$LOG_FILE" 2>&1 &
BOT_PID=$!

# –ñ–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ, —á—Ç–æ–±—ã –±–æ—Ç —É—Å–ø–µ–ª –∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è
sleep 3

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø—Ä–æ—Ü–µ—Å—Å –≤—Å–µ –µ—â–µ –∑–∞–ø—É—â–µ–Ω
if ps -p "$BOT_PID" > /dev/null 2>&1; then
    echo "‚úÖ –ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω (PID: $BOT_PID)"
    echo "üìã –õ–æ–≥–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤: $LOG_FILE"
    echo ""
    echo "–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –ª–æ–≥–∞:"
    echo "---"
    tail -10 "$LOG_FILE" 2>/dev/null || echo "(–ª–æ–≥–∏ –ø–æ–∫–∞ –ø—É—Å—Ç—ã)"
    echo "---"
else
    echo "‚ùå –û—à–∏–±–∫–∞: –±–æ—Ç –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è –∏–ª–∏ –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞"
    echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: tail -50 $LOG_FILE"
    exit 1
fi
