# Архитектура проекта KBJU Bot

## Обзор

Этот документ описывает архитектуру проекта и рекомендации по дальнейшему развитию.

## Структура проекта

### Основные модули

```
kbju_2026_bot/
├── bot.py                 # Точка входа, регистрация handlers
├── config.py              # Конфигурация приложения
├── database/              # Работа с базой данных (разделена по доменам)
│   ├── __init__.py
│   ├── connection.py      # Управление подключением
│   ├── users.py           # Работа с пользователями
│   ├── days.py            # Работа с днями
│   └── food_entries.py    # Работа с записями о еде
├── handlers/              # Обработчики сообщений и команд
│   ├── commands.py        # Обработчики команд (/start, /help и т.д.)
│   ├── messages.py        # Обработчики текстовых сообщений
│   ├── callbacks.py       # Обработчики callback кнопок
│   └── media.py           # Обработчики медиа (фото, голос)
├── services/              # Слой бизнес-логики
│   ├── food_service.py    # Сервис для работы с едой
│   ├── day_service.py     # Сервис для работы с днями
│   └── user_service.py    # Сервис для работы с пользователями
├── sessions/              # Система управления сессиями
│   ├── session_manager.py # Менеджер сессий
│   └── session_types.py   # Типы сессий и их обработчики
├── ai/                    # Работа с AI
│   ├── service.py         # Сервис для работы с GigaChat API
│   └── formatter.py       # Форматирование данных для AI
├── texts/                 # Текстовые сообщения
│   └── telegram_texts.py  # Тексты для Telegram
└── prompts/               # Промпты для AI
    ├── kbju_prompt.txt
    └── edit_prompt.txt
```

## Ключевые архитектурные решения

### 1. Система сессий

**Проблема:** Изначально сессии управлялись через проверки `if 'editing_entry_ids' in context.user_data`, что не масштабировалось.

**Решение:** Создана централизованная система управления сессиями через `SessionManager` и классы сессий.

**Преимущества:**
- Легко добавлять новые типы сессий
- Четкое разделение логики обработки разных состояний
- Готовность к обработке разных типов сообщений (текст, фото, голос)

**Типы сессий:**
- `DEFAULT` - обычная сессия, ожидание сообщений о еде
- `EDITING` - сессия редактирования записей
- `ONBOARDING` - сессия приветствия и онбординга (готово к реализации)
- `KBJU_SETUP` - сессия настройки дневной нормы КБЖУ (готово к реализации)
- `TIMEZONE_SETUP` - сессия настройки часового пояса (готово к реализации)

**Использование:**
```python
from sessions import SessionManager, SessionType

# Установить сессию
SessionManager.set_session(context, SessionType.EDITING, {'editing_entry_ids': [1, 2]})

# Получить текущую сессию
session = SessionManager.get_session(context)

# Обработать сообщение через сессию
await session.handle_message(update, context)

# Очистить сессию
SessionManager.clear_session(context)
```

### 2. Разделение database.py

**Проблема:** Изначально `database.py` содержал 536 строк и смешивал разные домены.

**Решение:** Разделен на модули по доменам:
- `connection.py` - управление подключением и инициализация
- `users.py` - работа с пользователями
- `days.py` - работа с днями
- `food_entries.py` - работа с записями о еде

**Преимущества:**
- Лучшая организация кода
- Легче найти нужную функцию
- Проще тестировать отдельные модули

### 3. Слой сервисов

**Проблема:** Бизнес-логика была размазана между handlers и database.

**Решение:** Создан слой сервисов, который инкапсулирует бизнес-логику:
- `FoodService` - обработка еды, редактирование, удаление
- `DayService` - работа с днями
- `UserService` - работа с пользователями

**Преимущества:**
- Четкое разделение ответственности
- Легче тестировать бизнес-логику
- Handlers становятся тоньше и проще

### 4. Обработка разных типов сообщений

**Готовность к будущему:** Структура подготовлена для обработки:
- Текстовых сообщений (реализовано)
- Фото (структура готова, реализация в будущем)
- Голосовых сообщений (структура готова, реализация в будущем)

Каждая сессия имеет методы:
- `handle_message()` - обработка текста
- `handle_photo()` - обработка фото
- `handle_voice()` - обработка голоса

## Рекомендации по дальнейшему развитию

### 1. Добавление новых сессий

Для добавления новой сессии:

1. Добавить тип в `SessionType` enum в `sessions/session_manager.py`
2. Создать класс сессии в `sessions/session_types.py`, наследуя от `BaseSession`
3. Зарегистрировать класс в `SESSION_CLASSES` в `SessionManager`
4. Реализовать методы `handle_message()`, `handle_photo()`, `handle_voice()`

**Пример для сессии онбординга:**
```python
class OnboardingSession(BaseSession):
    async def handle_message(self, update: Update, context: CallbackContext) -> bool:
        step = context.user_data.get('onboarding_step', 0)
        
        if step == 0:
            await update.message.reply_text("Добро пожаловать! Как вас зовут?")
            context.user_data['onboarding_step'] = 1
            return True
        elif step == 1:
            # Сохраняем имя и переходим к следующему шагу
            name = update.message.text
            context.user_data['onboarding_name'] = name
            await update.message.reply_text(f"Приятно познакомиться, {name}!")
            SessionManager.clear_session(context)
            return True
        
        return False
```

### 2. Обработка фото

Для реализации распознавания блюд по фото:

1. Добавить обработку в `DefaultSession.handle_photo()`
2. Создать сервис для работы с фото (например, `PhotoRecognitionService`)
3. Интегрировать с AI сервисом или внешним API для распознавания изображений

**Пример структуры:**
```python
# services/photo_service.py
class PhotoRecognitionService:
    async def recognize_food(self, photo_file) -> List[Dict]:
        # Отправка фото в AI/API для распознавания
        pass
```

### 3. Обработка голосовых сообщений

Для реализации обработки голосовых сообщений:

1. Добавить обработку в `DefaultSession.handle_voice()`
2. Создать сервис для преобразования речи в текст
3. Использовать существующую логику обработки текста

**Пример структуры:**
```python
# services/voice_service.py
class VoiceService:
    async def speech_to_text(self, voice_file) -> str:
        # Преобразование голоса в текст
        pass
```

### 4. Тестирование

Рекомендуется добавить тесты для:
- Сервисов (unit-тесты)
- Сессий (unit-тесты)
- Handlers (integration-тесты)

**Пример структуры:**
```
tests/
├── unit/
│   ├── test_food_service.py
│   ├── test_day_service.py
│   └── test_session_manager.py
└── integration/
    ├── test_handlers.py
    └── test_commands.py
```

### 5. Миграция со старой структуры

Старый `database.py` можно оставить для обратной совместимости или удалить после полного перехода на новую структуру. Все импорты обновлены для работы с новой структурой через `database/__init__.py`.

## Лучшие практики

1. **Разделение ответственности:** Каждый модуль отвечает за свою область
2. **Инкапсуляция бизнес-логики:** Вся бизнес-логика в сервисах, не в handlers
3. **Централизованное управление состояниями:** Через SessionManager
4. **Готовность к расширению:** Структура позволяет легко добавлять новые функции
5. **Чистый код:** Понятные имена, документация, типизация

## Миграция

Для перехода на новую структуру:

1. ✅ Система сессий создана
2. ✅ Database разделена на модули
3. ✅ Слой сервисов создан
4. ✅ Handlers обновлены
5. ✅ Структура для медиа подготовлена

Старый `database.py` можно удалить после проверки работоспособности новой структуры.
